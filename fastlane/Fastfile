require 'pathname'

default_platform(:ios)

platform :ios do
  desc "Run tests including snapshots"
  lane :test do
    # Clean existing directory
    FileUtils.rm_rf("Tests/ReferenceImages")
    
    # Clone snapshots repository
    sh("git clone https://x-access-token:#{ENV['REPO_TOKEN']}@github.com/#{ENV['SNAPSHOT_REPO']}.git snapshots_repo")
    
    # Use Fastlane's UI for logging
    UI.important("DEBUG: Current directory: #{Dir.pwd}")
    UI.important("DEBUG: Full path to Tests/ReferenceImages: #{File.expand_path('Tests/ReferenceImages')}")
    
    FileUtils.mkdir_p("Tests/ReferenceImages")
    
    if Dir.exist?("snapshots_repo/ReferenceImages")
      UI.message("Source directory:")
      sh("ls -la snapshots_repo/ReferenceImages")
      
      FileUtils.cp_r(Dir["snapshots_repo/ReferenceImages/."], "Tests/ReferenceImages/")
      
      UI.message("Destination directory after copy:")
      sh("ls -la Tests/ReferenceImages")
      
      UI.important("DEBUG: Full find output:")
      sh("find #{File.expand_path('Tests/ReferenceImages')} -type f -ls")
    end

    scan(
      scheme: "GithubActions",
      device: "iPhone SE (3rd generation)",
      clean: true,
      configuration: "Debug",
      derived_data_path: "DerivedData",
      buildlog_path: "fastlane/logs"
    )
  end
end